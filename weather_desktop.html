<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ª± B√°o Th·ªùi Ti·∫øt üå¶Ô∏è</title>
    <!-- Th√™m manifest.json ƒë·ªÉ h·ªó tr·ª£ PWA -->
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            background-color: #1a202c;
            overflow-x: hidden;
        }

        #weather-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            transition: background 1s ease-in-out;
            background: linear-gradient(135deg, #1A202C, #2D3748);
        }

        .container {
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 3rem;
            text-align: center;
            width: 100%;
            max-width: 600px;
            position: relative;
            z-index: 1;
        }
        h1 {
            font-size: 2.75rem;
            font-weight: 800;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .search-box {
            position: relative;
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }
        input {
            flex-grow: 1;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 9999px;
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 1rem;
            outline: none;
            transition: background-color 0.3s ease;
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        input:focus {
            background-color: rgba(255, 255, 255, 0.4);
        }
        button {
            background-color: #1A92FF;
            color: #fff;
            padding: 1rem 2rem;
            border: none;
            border-radius: 9999px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        button:hover {
            background-color: #0070e2;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        button:active {
            transform: scale(0.95);
        }
        #settings-btn {
            background-color: transparent;
            position: absolute;
            top: 2rem;
            right: 2rem;
            padding: 0.5rem;
            border-radius: 50%;
            font-size: 1.5rem;
            line-height: 1;
        }
        #settings-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: rotate(30deg);
        }
        
        #current-time {
            position: absolute;
            top: 2rem;
            left: 2rem;
            font-size: 1.5rem;
            font-weight: 600;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 1rem;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
        }
        .suggestions li {
            padding: 0.75rem 1.5rem;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .suggestions li:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .weather-info {
            padding: 2.5rem;
            border-radius: 2rem;
            background-color: rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 2rem;
            text-align: left;
            transition: all 0.5s ease;
        }
        .weather-info h2 {
            font-size: 2.25rem;
            font-weight: 800;
            text-align: center;
        }
        .weather-info .temp {
            font-size: 5rem;
            font-weight: 800;
            text-align: center;
        }
        
        .weather-info .weather-text {
            font-size: 1.5rem;
            font-weight: 600;
            text-align: center;
            margin-top: -1.5rem;
            margin-bottom: 1rem;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            font-size: 1.25rem;
        }
        
        .forecast-section {
            margin-top: 2rem;
            text-align: center;
        }
        .forecast-section h3 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }
        .forecast-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
        }
        .hourly-forecast-container {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
            justify-content: flex-start;
        }
        .forecast-card, .hourly-forecast-card {
            flex: 0 0 120px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 1rem;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .forecast-card:hover, .hourly-forecast-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2);
        }

        .forecast-card .icon-placeholder, .hourly-forecast-card .icon-placeholder {
            width: 4rem;
            height: 4rem;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .hourly-forecast-card {
            flex: 0 0 100px;
            min-width: 100px;
        }

        .settings-panel {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-top: 2rem;
            text-align: left;
        }

        .settings-panel h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .settings-panel label {
            display: block;
            margin-bottom: 0.5rem;
            cursor: pointer;
            user-select: none;
        }
        .location-btn {
            background-color: #4A5568;
        }
        .location-btn:hover {
            background-color: #2D3748;
        }
        /* Loading overlay */
        #loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            gap: 1rem;
        }

        #loading-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        #loading-icon {
            width: 8rem;
            height: 8rem;
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .desktop-only-container {
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n tr√™n desktop */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            text-align: center;
            padding: 1rem;
        }

        canvas {
            max-width: 100%;
            height: auto;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <div id="weather-bg"></div>
    
    <!-- Canvas for mobile-only message -->
    <div id="mobile-message-container" class="desktop-only-container">
        <canvas id="mobile-canvas"></canvas>
    </div>

    <!-- Main weather app container -->
    <div id="main-weather-container" class="container">
        <div id="storm-alert" style="display:none; background:#f87171; color:white; font-weight:bold; border-radius:1rem; padding:1em; margin-bottom:1em; text-align:center; font-size:1.1em; display:flex; align-items:center; justify-content:center;gap:0.7em;">
    <img src="https://tuanphong3108.github.io/weather/isolated_thunderstorms.png" alt="thunderstorm" style="width:2em;height:2em;display:inline-block;vertical-align:middle;">
    <span id="storm-alert-message">C√≥ b√£o/d√¥ng s·∫Øp ƒë·∫øn!</span>
</div>
        <div id="current-time"></div>
        <button id="settings-btn" class="absolute top-8 right-8 text-white text-2xl transition-transform duration-300 transform hover:rotate-45">
            <span class="material-symbols-outlined">settings</span>
        </button>
        <h1 class="font-extrabold text-white text-4xl mb-6">D·ª± B√°o Th·ªùi Ti·∫øt</h1>
        <div class="search-box">
            <input type="text" id="city-input" placeholder="Nh·∫≠p t√™n th√†nh ph·ªë...">
            <button id="search-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-colors duration-200">T√¨m Ki·∫øm</button>
            <button id="current-location-btn" class="location-btn text-white font-bold py-3 px-6 rounded-full transition-colors duration-200">V·ªã tr√≠ hi·ªán t·∫°i</button>
            <ul id="suggestions" class="suggestions hidden"></ul>
        </div>
        <div id="weather-info" class="weather-info hidden">
            <!-- D·ªØ li·ªáu th·ªùi ti·∫øt s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y b·ªüi JavaScript -->
        </div>

        <!-- Settings Panel -->
        <div id="settings-panel" class="settings-panel hidden">
            <h2 class="text-3xl font-bold mb-4">C√†i ƒê·∫∑t</h2>
            
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-2">ƒê∆°n v·ªã nhi·ªát ƒë·ªô</h3>
                <div class="flex gap-4">
                    <label>
                        <input type="radio" name="temp-unit" value="celsius" checked>
                        Celsius (¬∞C)
                    </label>
                    <label>
                        <input type="radio" name="temp-unit" value="fahrenheit">
                        Fahrenheit (¬∞F)
                    </label>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-2">ƒê∆°n v·ªã t·ªëc ƒë·ªô gi√≥</h3>
                <div class="flex gap-4">
                    <label>
                        <input type="radio" name="wind-unit" value="ms" checked>
                        m/s
                    </label>
                    <label>
                        <input type="radio" name="wind-unit" value="kmh">
                        km/h
                    </label>
                </div>
            </div>

            <div>
                <h3 class="text-xl font-semibold mb-2">Ki·ªÉu Icon</h3>
                <div class="flex flex-col gap-2">
                    <label>
                        <input type="radio" name="icon-style" value="emoji">
                        Emoji
                    </label>
                    <label>
                        <input type="radio" name="icon-style" value="material">
                        Material 3
                    </label>
                    <label>
                        <input type="radio" name="icon-style" value="pixel" checked>
                        Google Pixel Weather
                    </label>
                </div>
            </div>

            <div class="mt-6 pt-6 border-t border-gray-600">
                <h3 class="text-xl font-semibold mb-2">V·ªã tr√≠</h3>
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="auto-location-toggle">
                    T·ª± ƒë·ªông hi·ªán th·ªùi ti·∫øt ·ªü v·ªã tr√≠ hi·ªán t·∫°i
                </label>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="hidden">
            <img id="loading-icon" alt="Loading icon" />
            <p id="loading-text" class="text-lg font-semibold">ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cityInput = document.getElementById('city-input');
            const searchBtn = document.getElementById('search-btn');
            const weatherInfoDiv = document.getElementById('weather-info');
            const suggestionsList = document.getElementById('suggestions');
            const weatherBg = document.getElementById('weather-bg');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsPanel = document.getElementById('settings-panel');
            const currentLocationBtn = document.getElementById('current-location-btn');
            const autoLocationToggle = document.getElementById('auto-location-toggle');
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingIcon = document.getElementById('loading-icon');
            const currentTimeDiv = document.getElementById('current-time');

            const mainWeatherContainer = document.getElementById('main-weather-container');
            const mobileMessageContainer = document.getElementById('mobile-message-container');
            const mobileCanvas = document.getElementById('mobile-canvas');
            const ctx = mobileCanvas.getContext('2d');

            let lastFetchedCity = null;
            let lastFetchedCoords = null;

            // S·ª≠ d·ª•ng localStorage ƒë·ªÉ ghi nh·ªõ c√†i ƒë·∫∑t
            const settings = {
                tempUnit: localStorage.getItem('tempUnit') || 'celsius',
                windUnit: localStorage.getItem('windUnit') || 'ms',
                iconStyle: localStorage.getItem('iconStyle') || 'pixel', 
                autoLocation: localStorage.getItem('autoLocation') === 'true'
            };

            const WEATHER_CODES = {
                0: { emoji: "‚òÄÔ∏è", material: "wb_sunny", night_emoji: "üåô", night_material: "nightlight_round", text: "Tr·ªùi quang, m√¢y t·∫°nh", color: ["#4FC3F7", "#00BCD4"] },
                1: { emoji: "üå§Ô∏è", material: "partly_cloudy_day", night_emoji: "‚òÅÔ∏è", night_material: "partly_cloudy_night", text: "Tr·ªùi quang, ch·ªß y·∫øu n·∫Øng", color: ["#64B5F6", "#81C784"] },
                2: { emoji: "‚õÖÔ∏è", material: "cloudy", text: "Tr·ªùi quang, m√¢y r·∫£i r√°c", color: ["#A5D6A7", "#90A4AE"] },
                3: { emoji: "‚òÅÔ∏è", material: "cloudy", text: "Tr·ªùi nhi·ªÅu m√¢y", color: ["#B0BEC5", "#78909C"] },
                45: { emoji: "üå´Ô∏è", material: "foggy", text: "S∆∞∆°ng m√π", color: ["#ECEFF1", "#CFD8DC"] },
                48: { emoji: "üå´Ô∏è", material: "foggy", text: "S∆∞∆°ng m√π ƒë√≥ng bƒÉng", color: ["#B0BEC5", "#90A4AE"] },
                51: { emoji: "üåßÔ∏è", material: "rainy", text: "M∆∞a ph√πn nh·∫π", color: ["#90CAF9", "#42A5F5"] },
                53: { emoji: "üåßÔ∏è", material: "rainy", text: "M∆∞a ph√πn v·ª´a", color: ["#64B5F6", "#2196F3"] },
                55: { emoji: "üåßÔ∏è", material: "rainy", text: "M∆∞a ph√πn n·∫∑ng", color: ["#42A5F5", "#1E88E5"] },
                56: { emoji: "üå®Ô∏è", material: "snowing", text: "M∆∞a tuy·∫øt nh·∫π ƒë√≥ng bƒÉng", color: ["#E1F5FE", "#B3E5FC"] },
                57: { emoji: "üå®Ô∏è", material: "snowing", text: "M∆∞a tuy·∫øt v·ª´a ƒë√≥ng bƒÉng", color: ["#B3E5FC", "#81D4FA"] },
                61: { emoji: "üíß", material: "rainy", text: "M∆∞a nh·∫π", color: ["#90CAF9", "#42A5F5"] },
                63: { emoji: "üíß", material: "rainy", text: "M∆∞a v·ª´a", color: ["#64B5F6", "#2196F3"] },
                65: { emoji: "üíß", material: "rainy", text: "M∆∞a n·∫∑ng h·∫°t", color: ["#42A5F5", "#1E88E5"] },
                66: { emoji: "üå®Ô∏è", material: "snowing", text: "M∆∞a nh·∫π ƒë√≥ng bƒÉng", color: ["#E1F5FE", "#B3E5FC"] },
                67: { emoji: "üå®Ô∏è", material: "snowing", text: "M∆∞a v·ª´a ƒë√≥ng bƒÉng", color: ["#B3E5FC", "#81D4FA"] },
                71: { emoji: "‚ùÑÔ∏è", material: "ac_unit", text: "Tuy·∫øt r∆°i nh·∫π", color: ["#E1F5FE", "#B3E5FC"] },
                73: { emoji: "‚ùÑÔ∏è", material: "ac_unit", text: "Tuy·∫øt r∆°i v·ª´a", color: ["#B3E5FC", "#81D4FA"] },
                75: { emoji: "‚ùÑÔ∏è", material: "ac_unit", text: "Tuy·∫øt r∆°i n·∫∑ng", color: ["#81D4FA", "#4FC3F7"] },
                77: { emoji: "üå®Ô∏è", material: "snowing", text: "H·∫°t tuy·∫øt r∆°i", color: ["#B3E5FC", "#81D4FA"] },
                80: { emoji: "‚õàÔ∏è", material: "thunderstorm", text: "M∆∞a r√†o nh·∫π", color: ["#8D6E63", "#6D4C41"] },
                81: { emoji: "‚õàÔ∏è", material: "thunderstorm", text: "M∆∞a r√†o v·ª´a", color: ["#6D4C41", "#5D4037"] },
                82: { emoji: "‚õàÔ∏è", material: "thunderstorm", text: "M∆∞a r√†o d·ªØ d·ªôi", color: ["#5D4037", "#4E342E"] },
                85: { emoji: "üå®Ô∏è", material: "snowing", text: "M∆∞a tuy·∫øt nh·∫π", color: ["#E1F5FE", "#B3E5FC"] },
                86: { emoji: "üå®Ô∏è", material: "snowing", text: "M∆∞a tuy·∫øt v·ª´a", color: ["#B3E5FC", "#81D4FA"] },
                95: { emoji: "‚ö°Ô∏è", material: "thunderstorm", text: "D√¥ng b√£o", color: ["#6D4C41", "#5D4037"] },
                96: { emoji: "‚ö°Ô∏è", material: "thunderstorm", text: "D√¥ng b√£o c√≥ m∆∞a ƒë√° nh·∫π", color: ["#5D4037", "#4E342E"] },
                99: { emoji: "‚ö°Ô∏è", material: "thunderstorm", text: "D√¥ng b√£o c√≥ m∆∞a ƒë√° n·∫∑ng", color: ["#4E342E", "#3E2723"] },
            };
            
            // Link tr·ª±c ti·∫øp t·ªõi repo GitHub cho icon Pixel
            const PIXEL_BASE_URL = 'https://tuanphong3108.github.io/weather/'; // ƒê√£ ƒë·ªïi link theo y√™u c·∫ßu c·ªßa bro
            const PIXEL_ICONS = {
                '0': { day: 'clear_day.png', night: 'clear_night.png' },
                '1': { day: 'mostly_clear_day.png', night: 'mostly_clear_night.png' },
                '2': { day: 'partly_cloudy_day.png', night: 'partly_cloudy_night.png' },
                '3': { day: 'cloudy.png', night: 'cloudy.png' },
                '45': { day: 'haze_fog_dust_smoke.png', night: 'haze_fog_dust_smoke.png' },
                '48': { day: 'haze_fog_dust_smoke.png', night: 'haze_fog_dust_smoke.png' },
                '51': { day: 'drizzle.png', night: 'drizzle.png' },
                '53': { day: 'drizzle.png', night: 'drizzle.png' },
                '55': { day: 'drizzle.png', night: 'drizzle.png' },
                '56': { day: 'sleet_hail.png', night: 'sleet_hail.png' },
                '57': { day: 'sleet_hail.png', night: 'sleet_hail.png' },
                '61': { day: 'showers_rain.png', night: 'showers_rain.png' },
                '63': { day: 'showers_rain.png', night: 'showers_rain.png' },
                '65': { day: 'heavy_rain.png', night: 'heavy_rain.png' }, // Changed to heavy_rain based on weather code
                '66': { day: 'mixed_rain_hail_sleet.png', night: 'mixed_rain_hail_sleet.png' },
                '67': { day: 'mixed_rain_hail_sleet.png', night: 'mixed_rain_hail_sleet.png' },
                '71': { day: 'showers_snow.png', night: 'showers_snow.png' },
                '73': { day: 'showers_snow.png', night: 'showers_snow.png' },
                '75': { day: 'heavy_snow.png', night: 'heavy_snow.png' }, // Changed to heavy_snow
                '77': { day: 'flurries.png', night: 'flurries.png' },
                '80': { day: 'scattered_showers_day.png', night: 'scattered_showers_night.png' },
                81: { day: 'showers_rain.png', night: 'showers_rain.png' },
                82: { day: 'heavy_rain.png', night: 'heavy_rain.png' },
                85: { day: 'scattered_snow_showers_day.png', night: 'scattered_snow_showers_night.png' },
                86: { day: 'showers_snow.png', night: 'showers_snow.png' },
                95: { day: 'isolated_thunderstorms.png', night: 'isolated_thunderstorms.png' },
                96: { day: 'isolated_scattered_thunderstorms_day.png', night: 'isolated_scattered_thunderstorms_night.png' },
                99: { day: 'strong_thunderstorms.png', night: 'strong_thunderstorms.png' },
            };

            const DETAIL_ICONS = {
                humidity: { emoji: "üíß", material: "humidity_mid" },
                wind: { emoji: "üí®", material: "air" },
                uv: { emoji: "‚òÄÔ∏è", material: "wb_sunny" },
                visibility: { emoji: "üëÄ", material: "visibility" }
            };

            const updateTime = () => {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    // UI ONLY: Th√™m h√¨nh ·∫£nh clear_day ho·∫∑c clear_night ph√≠a tr∆∞·ªõc gi·ªù + ch·ªØ (Theo gi·ªù m√°y t√≠nh)
    let iconUrl = '';
    if (now.getHours() >= 6 && now.getHours() < 18) {
        iconUrl = 'https://tuanphong3108.github.io/weather/clear_day.png';
    } else {
        iconUrl = 'https://tuanphong3108.github.io/weather/clear_night.png';
    }
    currentTimeDiv.innerHTML = `<img src="${iconUrl}" alt="" style="width:2em;height:2em;vertical-align:middle;margin-right:0.5em;display:inline-block;">${hours}:${minutes} <span style="font-size:0.9em;opacity:0.8;">(Theo gi·ªù m√°y t√≠nh)</span>`;
};
            
            // X·ª≠ l√Ω logic hi·ªÉn th·ªã canvas cho mobile
            const isMobile = () => {
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                return /(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|12|lg)|pluc|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(userAgent) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|lg)|al(av|ca|co)|amoi|an(d|on)|aq(on|t\-)|as(te|us)|attw|au(di|\-m|r |s )|bn(c|eg)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll)|dc\-s|de(mo|up)|di(al|go)|do(sh|sy)|ez\-(4|6)0|ga(ko|s)|ha(mo|mm)|hbro|heyv|ho(mo|ti)|hp(i|k)o|huck|huiz|i230|iac( |\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(mo|on)|leno|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(e|ui|xy)|mb(p|t)|me(rc|sm)|mi(ac|ad|ea|er|vk)|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|v)|ng(i|g)|nl(go|ps)|nr(bb|c)|nu(at|in)|nv(mo|th)|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|([1-8]|c))|pl(ay|w)|pn\-be|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|in|u\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(mo|ma)|sh(ko|oo)|si(em|sp)|smar|sh(oo|mo)|sm(a|r)t|so(up|s )|te(mp|sh)|tf(mo|ui)|tdg|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|80)|up\.(b|ly|sy)|upsi|vl(on|ow)|vm(ev|o|tf|t)|wa(sc|pk)|wg(4|5)|wk(ig|tr)|wmbi|wn|xfer|xo(l|so)|xs(dr|t)|yz|zeto|zte\-/i.test(userAgent.substr(4));
            };

            const drawCanvasMessage = () => {
                const text = "Hi·ªán t·∫°i Weather ch·ªâ kh·∫£ d·ª•ng tr√™n tr√¨nh duy·ªát d√†nh cho Windows, MacOS, Linux, ChromeOS,... (M√°y t√≠nh)";
                mobileCanvas.width = window.innerWidth * 0.9;
                mobileCanvas.height = window.innerHeight * 0.5;

                ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                ctx.fillRect(0, 0, mobileCanvas.width, mobileCanvas.height);
                
                ctx.font = '24px Inter, sans-serif';
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                const lines = [];
                let currentLine = '';
                const words = text.split(' ');
                const maxWidth = mobileCanvas.width - 40;

                for (let i = 0; i < words.length; i++) {
                    const testLine = currentLine + words[i] + ' ';
                    const metrics = ctx.measureText(testLine);
                    const testWidth = metrics.width;
                    if (testWidth > maxWidth && i > 0) {
                        lines.push(currentLine.trim());
                        currentLine = words[i] + ' ';
                    } else {
                        currentLine = testLine;
                    }
                }
                lines.push(currentLine.trim());

                const lineHeight = 30;
                let y = (mobileCanvas.height / 2) - (lines.length / 2) * lineHeight;
                
                for (let i = 0; i < lines.length; i++) {
                    ctx.fillText(lines[i], mobileCanvas.width / 2, y);
                    y += lineHeight;
                }
            };
            
            window.addEventListener('resize', drawCanvasMessage);

            if (isMobile()) {
                mainWeatherContainer.style.display = 'none';
                mobileMessageContainer.style.display = 'flex';
                drawCanvasMessage();
            } else {
                mainWeatherContainer.style.display = 'block';
                mobileMessageContainer.style.display = 'none';
            }

            // ƒê·ªìng b·ªô c√†i ƒë·∫∑t t·ª´ localStorage khi t·∫£i trang
            document.querySelector(`input[name="temp-unit"][value="${settings.tempUnit}"]`).checked = true;
            document.querySelector(`input[name="wind-unit"][value="${settings.windUnit}"]`).checked = true;
            document.querySelector(`input[name="icon-style"][value="${settings.iconStyle}"]`).checked = true;
            autoLocationToggle.checked = settings.autoLocation;

            const showLoading = () => {
                const now = new Date();
                const currentHour = now.getHours();
                const isNight = currentHour >= 18 || currentHour < 6;
                const loadingIconUrl = isNight ? `${PIXEL_BASE_URL}clear_night.png` : `${PIXEL_BASE_URL}clear_day.png`;
                loadingIcon.src = loadingIconUrl;
                loadingOverlay.classList.remove('hidden');
                loadingOverlay.classList.add('visible');
                weatherInfoDiv.classList.add('hidden');
                document.getElementById('forecast-section')?.remove();
                document.getElementById('hourly-forecast-section')?.remove();
            };

            const hideLoading = () => {
                loadingOverlay.classList.remove('visible');
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                }, 300); // T∆∞∆°ng ·ª©ng v·ªõi th·ªùi gian chuy·ªÉn ƒë·ªïi
            };

            const displayMessage = (message, isError = false) => {
                hideLoading();
                weatherInfoDiv.innerHTML = `
                    <div class="text-center font-semibold text-lg ${isError ? 'text-red-400' : 'text-white'}">
                        ${message}
                    </div>
                `;
                weatherInfoDiv.classList.remove('hidden');
                document.getElementById('forecast-section')?.remove();
                document.getElementById('hourly-forecast-section')?.remove();
            };

            const setWeatherBackground = (weatherCode) => {
                const colors = WEATHER_CODES[weatherCode]?.color || ["#1A202C", "#2D3748"];
                weatherBg.style.background = `linear-gradient(135deg, ${colors[0]}, ${colors[1]})`;
            };

            const getIconHtml = (weatherCode, isNight, iconStyle, sizeClass = 'text-6xl') => {
                const weatherCodeInfo = WEATHER_CODES[weatherCode];
                if (iconStyle === 'material') {
                    const materialIcon = isNight && weatherCodeInfo?.night_material ? weatherCodeInfo.night_material : weatherCodeInfo?.material;
                    return `<span class="material-symbols-outlined ${sizeClass}">${materialIcon || "help"}</span>`;
                } else if (iconStyle === 'pixel') {
                    const iconFile = PIXEL_ICONS[weatherCode]?.[isNight ? 'night' : 'day'];
                    const iconUrl = `${PIXEL_BASE_URL}${iconFile || 'clear_day.png'}`;
                    return `<img src="${iconUrl}" alt="weather icon" class="w-16 h-16"/>`;
                } else {
                    const emojiIcon = isNight && weatherCodeInfo?.night_emoji ? weatherCodeInfo.night_emoji : weatherCodeInfo?.emoji;
                    return `<span class="${sizeClass}">${emojiIcon || "‚ùì"}</span>`;
                }
            };

            const getDetailIcon = (key) => {
                const icon = DETAIL_ICONS[key];
                if (settings.iconStyle === 'emoji') {
                    return `<span class="text-3xl">${icon.emoji}</span>`;
                }
                return `<span class="material-symbols-outlined text-3xl">${icon.material}</span>`;
            };
            
            // H√†m chuy·ªÉn ƒë·ªïi nhi·ªát ƒë·ªô
            const convertTemp = (temp, unit) => {
                if (unit === 'fahrenheit') {
                    return ((temp * 9/5) + 32).toFixed(1);
                }
                return temp.toFixed(1);
            };

            const displayWeather = (currentData, dailyData, hourlyData, city, uvIndex, timezone, lat, lon) => {
                hideLoading();
                // Ki·ªÉm tra b√£o/d√¥ng/thunderstorm ch·ªâ v·ªõi v·ªã tr√≠ ƒëang xem
const stormCodes = [95, 96, 99, 80, 81, 82];
let isStormComing = false;
let stormDesc = "";

for (let i = 0; i < Math.min(7, dailyData.weather_code.length); i++) {
    if (stormCodes.includes(dailyData.weather_code[i])) {
        isStormComing = true;
        stormDesc = WEATHER_CODES[dailyData.weather_code[i]]?.text || "C√≥ b√£o/d√¥ng s·∫Øp ƒë·∫øn!";
        break;
    }
}

const stormAlertDiv = document.getElementById('storm-alert');
const stormAlertMsg = document.getElementById('storm-alert-message');
if (isStormComing) {
    stormAlertMsg.textContent = `C·∫£nh b√°o: ${stormDesc} trong m·ªôt v√†i ng√†y t·ªõi!`;
    stormAlertDiv.style.display = 'flex'; // flex ƒë·ªÉ c√≥ ·∫£nh + ch·ªØ ƒë·∫πp khi c√≥ c·∫£nh b√°o
} else {
    stormAlertDiv.style.display = 'none'; // ·∫®n khi kh√¥ng c√≥ c·∫£nh b√°o
}
                lastFetchedCity = city;
                lastFetchedCoords = { lat, lon };

                const tempInCelsius = currentData.temperature_2m;
                const displayTemp = convertTemp(tempInCelsius, settings.tempUnit);
                const tempUnitText = settings.tempUnit === 'celsius' ? '¬∞C' : '¬∞F';
                
                let displayWindSpeed = currentData.wind_speed_10m;
                let windUnitText = 'km/h';
                if (settings.windUnit === 'ms') {
                    displayWindSpeed = (displayWindSpeed / 3.6).toFixed(1);
                    windUnitText = 'm/s';
                }
                
                const visibilityInKm = (currentData.visibility / 1000).toFixed(1);
                const humidity = currentData.relative_humidity_2m;
                const weatherCode = currentData.weather_code;
                const weatherText = WEATHER_CODES[weatherCode]?.text || "Kh√¥ng r√µ";

                const localTime = new Date().toLocaleTimeString('en-US', { timeZone: timezone, hour12: false });
                const localHour = parseInt(localTime.split(':')[0], 10);
                const isNight = localHour >= 18 || localHour < 6;
                
                const iconHtml = getIconHtml(weatherCode, isNight, settings.iconStyle);

                setWeatherBackground(weatherCode);

                const weatherHtml = `
                    <h2 class="capitalize">${city}</h2>
                    <p class="weather-text">${weatherText}</p>
                    <div class="temp flex justify-center items-center">
                        ${iconHtml}
                        <span>${displayTemp}${tempUnitText}</span>
                    </div>
                    <div class="weather-details">
                        <div class="flex items-center gap-2">
                            ${getDetailIcon('humidity')}
                            <span>ƒê·ªô ·∫©m: <br/>${humidity}%</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${getDetailIcon('wind')}
                            <span>Gi√≥: <br/>${displayWindSpeed} ${windUnitText}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${getDetailIcon('uv')}
                            <span>UV: <br/>${uvIndex}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${getDetailIcon('visibility')}
                            <span>T·∫ßm nh√¨n: <br/>${visibilityInKm} km</span>
                        </div>
                    </div>
                `;
                weatherInfoDiv.innerHTML = weatherHtml;
                weatherInfoDiv.classList.remove('hidden');

                let forecastSection = document.getElementById('forecast-section');
                if (!forecastSection) {
                    forecastSection = document.createElement('div');
                    forecastSection.id = 'forecast-section';
                    forecastSection.className = 'forecast-section';
                    weatherInfoDiv.after(forecastSection);
                }
                // Thay ƒë·ªïi ti√™u ƒë·ªÅ t·ª´ 7 ng√†y th√†nh 6 ng√†y
                forecastSection.innerHTML = `<h3>D·ª± b√°o 6 ng√†y t·ªõi</h3><div class="forecast-container"></div>`;
                

                const forecastContainer = forecastSection.querySelector('.forecast-container');
                forecastContainer.innerHTML = '';
                
                // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p t·ª´ i = 1 ƒë·ªÉ b·ªè qua ng√†y hi·ªán t·∫°i
                for (let i = 1; i < 7; i++) {
                    const date = new Date(dailyData.time[i]);
                    const day = date.toLocaleDateString('vi-VN', { weekday: 'short' });
                    const dailyCode = dailyData.weather_code[i];
                    const minTemp = convertTemp(dailyData.temperature_2m_min[i], settings.tempUnit);
                    const maxTemp = convertTemp(dailyData.temperature_2m_max[i], settings.tempUnit);
                    
                    const dailyIconHtml = getIconHtml(dailyCode, false, settings.iconStyle, 'text-4xl');
                    
                    const card = `
                        <div class="forecast-card">
                            <h4 class="font-bold">${day}</h4>
                            <div class="icon-placeholder">${dailyIconHtml}</div>
                            <p class="font-semibold text-lg">${maxTemp}¬∞/${minTemp}¬∞</p>
                        </div>
                    `;
                    forecastContainer.innerHTML += card;
                }
                
                let hourlyForecastSection = document.getElementById('hourly-forecast-section');
                if (!hourlyForecastSection) {
                    hourlyForecastSection = document.createElement('div');
                    hourlyForecastSection.id = 'hourly-forecast-section';
                    hourlyForecastSection.className = 'forecast-section';
                    forecastSection.after(hourlyForecastSection);
                }
                hourlyForecastSection.innerHTML = `<h3>D·ª± b√°o h√†ng gi·ªù</h3><div class="hourly-forecast-container"></div>`;
                
                const hourlyContainer = hourlyForecastSection.querySelector('.hourly-forecast-container');
                hourlyContainer.innerHTML = '';

                const now = new Date();
                const currentHour = now.getHours();
                const tempUnitTextHourly = settings.tempUnit === 'celsius' ? '¬∞C' : '¬∞F';


                for (let i = 0; i < 24; i++) {
                    const time = new Date(hourlyData.time[i]);
                    const hour = time.getHours();
                    const hourlyTemp = convertTemp(hourlyData.temperature_2m[i], settings.tempUnit);
                    const hourlyCode = hourlyData.weather_code[i];
                    
                    const isHourlyNight = hour >= 18 || hour < 6;
                    const hourlyIconHtml = getIconHtml(hourlyCode, isHourlyNight, settings.iconStyle, 'text-3xl');
                    
                    const card = `
                        <div class="hourly-forecast-card">
                            <!-- Lu√¥n hi·ªÉn th·ªã gi·ªù, b·ªè "Hi·ªán t·∫°i" -->
                            <h4 class="font-bold">${hour}h</h4>
                            <div class="icon-placeholder">${hourlyIconHtml}</div>
                            <p class="font-semibold">${hourlyTemp}${tempUnitTextHourly}</p>
                        </div>
                    `;
                    hourlyContainer.innerHTML += card;
                }
            };
            
            const fetchWeather = async (lat, lon, city) => {
                showLoading();
                try {
                    const geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${city}&count=1&language=vi&format=json`);
                    if (!geoResponse.ok) {
                        throw new Error('L·ªói t√¨m ki·∫øm th√†nh ph·ªë');
                    }
                    const geoData = await geoResponse.json();
                    if (!geoData.results || geoData.results.length === 0) {
                        throw new Error('Kh√¥ng t√¨m th·∫•y th√†nh ph·ªë n√†y. Vui l√≤ng th·ª≠ l·∫°i!');
                    }
                    const { latitude, longitude, name, country } = geoData.results[0];
                    const fullCityName = `${name}, ${country}`;

                    const weatherResponse = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,visibility&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,uv_index_max&timezone=auto`);
                    if (!weatherResponse.ok) {
                        throw new Error('L·ªói khi l·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt');
                    }
                    const weatherData = await weatherResponse.json();

                    displayWeather(weatherData.current, weatherData.daily, weatherData.hourly, fullCityName, weatherData.daily.uv_index_max[0], weatherData.timezone, latitude, longitude);

                } catch (error) {
                    console.error("L·ªói:", error);
                    displayMessage(`L·ªói: ${error.message}`, true);
                }
            };

            const fetchWeatherByCoords = async (lat, lon) => {
                showLoading();
                try {
                    const geoResponse = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=vi`);
                    if (!geoResponse.ok) {
                        throw new Error('Kh√¥ng th·ªÉ t√¨m th·∫•y v·ªã tr√≠ c·ªßa b·∫°n.');
                    }
                    const geoData = await geoResponse.json();
                    const cityName = geoData.city || geoData.principalSubdivision || "V·ªã tr√≠ hi·ªán t·∫°i";

                    const weatherResponse = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,visibility&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,uv_index_max&timezone=auto`);
                    if (!weatherResponse.ok) {
                        throw new Error('L·ªói khi l·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt');
                    }
                    const weatherData = await weatherResponse.json();
                    
                    displayWeather(weatherData.current, weatherData.daily, weatherData.hourly, cityName, weatherData.daily.uv_index_max[0], weatherData.timezone, lat, lon);
                } catch (error) {
                    console.error("L·ªói:", error);
                    displayMessage(`L·ªói: ${error.message}`, true);
                }
            };
            
            searchBtn.addEventListener('click', () => {
                const city = cityInput.value.trim();
                if (city) {
                    fetchWeather(null, null, city);
                }
            });

            cityInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });

            cityInput.addEventListener('input', async () => {
                const query = cityInput.value.trim();
                if (query.length < 3) {
                    suggestionsList.classList.add('hidden');
                    return;
                }
                try {
                    const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=5&language=vi&format=json`);
                    const data = await response.json();
                    suggestionsList.innerHTML = '';
                    if (data.results) {
                        suggestionsList.classList.remove('hidden');
                        data.results.forEach(result => {
                            const li = document.createElement('li');
                            li.textContent = `${result.name}, ${result.country}`;
                            li.addEventListener('click', () => {
                                cityInput.value = li.textContent;
                                suggestionsList.classList.add('hidden');
                                fetchWeather(result.latitude, result.longitude, result.name);
                            });
                            suggestionsList.appendChild(li);
                        });
                    } else {
                        suggestionsList.classList.add('hidden');
                    }
                } catch (error) {
                    suggestionsList.classList.add('hidden');
                }
            });

            currentLocationBtn.addEventListener('click', () => {
                if ("geolocation" in navigator) {
                    showLoading();
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            fetchWeatherByCoords(lat, lon);
                        },
                        (error) => {
                            console.error("L·ªói:", error);
                            displayMessage("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. Vui l√≤ng cho ph√©p quy·ªÅn truy c·∫≠p.", true);
                        }
                    );
                } else {
                    displayMessage("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ Geolocation.", true);
                }
            });

            settingsBtn.addEventListener('click', () => {
                settingsPanel.classList.toggle('hidden');
            });

            settingsPanel.addEventListener('change', (e) => {
                if (e.target.name === 'temp-unit') {
                    settings.tempUnit = e.target.value;
                    localStorage.setItem('tempUnit', e.target.value);
                } else if (e.target.name === 'wind-unit') {
                    settings.windUnit = e.target.value;
                    localStorage.setItem('windUnit', e.target.value);
                } else if (e.target.name === 'icon-style') {
                    settings.iconStyle = e.target.value;
                    localStorage.setItem('iconStyle', e.target.value);
                } else if (e.target.id === 'auto-location-toggle') {
                    settings.autoLocation = e.target.checked;
                    localStorage.setItem('autoLocation', e.target.checked);
                    if (settings.autoLocation) {
                        currentLocationBtn.click();
                    }
                }

                if (lastFetchedCoords) {
                    fetchWeatherByCoords(lastFetchedCoords.lat, lastFetchedCoords.lon);
                } else if (lastFetchedCity) {
                    fetchWeather(null, null, lastFetchedCity);
                }
            });

            if (settings.autoLocation) {
                currentLocationBtn.click();
            }

            // C·∫≠p nh·∫≠t th·ªùi gian m·ªói ph√∫t
            updateTime();
            setInterval(updateTime, 60000); // 60 gi√¢y
        });
    </script>
    <script>
        // ƒêƒÉng k√Ω Service Worker ƒë·ªÉ ·ª©ng d·ª•ng ho·∫°t ƒë·ªông offline
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                }).catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
            });
        }
    </script>
</body>
</html>
