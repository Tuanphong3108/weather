<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ª± B√°o Th·ªùi Ti·∫øt üå¶Ô∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- Th√™m manifest v√† icon cho PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            background-color: #1a202c;
            overflow-x: hidden;
        }

        #weather-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            transition: background 1s ease-in-out;
            background: linear-gradient(135deg, #1A202C, #2D3748);
        }

        .container {
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 3rem;
            text-align: center;
            width: 100%;
            max-width: 600px;
            position: relative;
            z-index: 1;
        }
        h1 {
            font-size: 2.75rem;
            font-weight: 800;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .search-box {
            position: relative;
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }
        input {
            flex-grow: 1;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 9999px;
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 1rem;
            outline: none;
            transition: background-color 0.3s ease;
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        input:focus {
            background-color: rgba(255, 255, 255, 0.4);
        }
        button {
            background-color: #1A92FF;
            color: #fff;
            padding: 1rem 2rem;
            border: none;
            border-radius: 9999px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        button:hover {
            background-color: #0070e2;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        button:active {
            transform: scale(0.95);
        }
        #settings-btn {
            background-color: transparent;
            position: absolute;
            top: 2rem;
            right: 2rem;
            padding: 0.5rem;
            border-radius: 50%;
            font-size: 1.5rem;
            line-height: 1;
        }
        #settings-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: rotate(30deg);
        }

        .suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 1rem;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
        }
        .suggestions li {
            padding: 0.75rem 1.5rem;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .suggestions li:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .weather-info {
            padding: 2.5rem;
            border-radius: 2rem;
            background-color: rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 2rem;
            text-align: left;
            transition: all 0.5s ease;
        }
        .weather-info h2 {
            font-size: 2.25rem;
            font-weight: 800;
            text-align: center;
        }
        .weather-info .temp {
            font-size: 5rem;
            font-weight: 800;
            text-align: center;
        }
        .weather-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            font-size: 1.25rem;
        }
        
        .forecast-section {
            margin-top: 2rem;
            text-align: center;
        }
        .forecast-section h3 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }
        .forecast-container {
            display: flex;
            justify-content: center;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
        }
        .forecast-card {
            flex: 0 0 120px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 1rem;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .forecast-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2);
        }

        .forecast-card .icon-placeholder {
            width: 4rem;
            height: 4rem;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .settings-panel {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-top: 2rem;
            text-align: left;
        }

        .settings-panel h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .settings-panel label {
            display: block;
            margin-bottom: 0.5rem;
            cursor: pointer;
            user-select: none;
        }
        .location-btn {
            background-color: #4A5568;
        }
        .location-btn:hover {
            background-color: #2D3748;
        }
    </style>
</head>
<body>
    <div id="weather-bg"></div>
    <div class="container">
        <button id="settings-btn" class="absolute top-8 right-8 text-white text-2xl transition-transform duration-300 transform hover:rotate-45">‚öôÔ∏è</button>
        <h1 class="font-extrabold text-white text-4xl mb-6">D·ª± B√°o Th·ªùi Ti·∫øt</h1>
        <div class="search-box">
            <input type="text" id="city-input" placeholder="Nh·∫≠p t√™n th√†nh ph·ªë...">
            <button id="search-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full transition-colors duration-200">T√¨m Ki·∫øm</button>
            <button id="current-location-btn" class="location-btn text-white font-bold py-3 px-6 rounded-full transition-colors duration-200">V·ªã tr√≠ hi·ªán t·∫°i</button>
            <ul id="suggestions" class="suggestions hidden"></ul>
        </div>
        <div id="weather-info" class="weather-info hidden">
            <!-- D·ªØ li·ªáu th·ªùi ti·∫øt s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y b·ªüi JavaScript -->
        </div>

        <!-- Settings Panel -->
        <div id="settings-panel" class="settings-panel hidden">
            <h2 class="text-3xl font-bold mb-4">C√†i ƒê·∫∑t</h2>
            
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-2">ƒê∆°n v·ªã nhi·ªát ƒë·ªô</h3>
                <div class="flex gap-4">
                    <label>
                        <input type="radio" name="temp-unit" value="celsius" checked>
                        Celsius (¬∞C)
                    </label>
                    <label>
                        <input type="radio" name="temp-unit" value="fahrenheit">
                        Fahrenheit (¬∞F)
                    </label>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-2">ƒê∆°n v·ªã t·ªëc ƒë·ªô gi√≥</h3>
                <div class="flex gap-4">
                    <label>
                        <input type="radio" name="wind-unit" value="ms" checked>
                        m/s
                    </label>
                    <label>
                        <input type="radio" name="wind-unit" value="kmh">
                        km/h
                    </label>
                </div>
            </div>

            <div>
                <h3 class="text-xl font-semibold mb-2">Ki·ªÉu Icon</h3>
                <div class="flex flex-col gap-2">
                    <label>
                        <input type="radio" name="icon-style" value="emoji" checked>
                        Emoji
                    </label>
                    <label>
                        <input type="radio" name="icon-style" value="material">
                        Material 3
                    </label>
                    <label>
                        <input type="radio" name="icon-style" value="pixel">
                        Google Pixel Weather
                    </label>
                </div>
            </div>

            <div class="mt-6 pt-6 border-t border-gray-600">
                <h3 class="text-xl font-semibold mb-2">V·ªã tr√≠</h3>
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="auto-location-toggle">
                    T·ª± ƒë·ªông hi·ªán th·ªùi ti·∫øt ·ªü v·ªã tr√≠ hi·ªán t·∫°i
                </label>
            </div>
        </div>
    </div>

    <script>
        // ƒêƒÉng k√Ω Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const cityInput = document.getElementById('city-input');
            const searchBtn = document.getElementById('search-btn');
            const weatherInfoDiv = document.getElementById('weather-info');
            const suggestionsList = document.getElementById('suggestions');
            const weatherBg = document.getElementById('weather-bg');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsPanel = document.getElementById('settings-panel');
            const currentLocationBtn = document.getElementById('current-location-btn');
            const autoLocationToggle = document.getElementById('auto-location-toggle');
            
            // S·ª≠ d·ª•ng localStorage ƒë·ªÉ ghi nh·ªõ c√†i ƒë·∫∑t
            const settings = {
                tempUnit: localStorage.getItem('tempUnit') || 'celsius',
                windUnit: localStorage.getItem('windUnit') || 'ms',
                iconStyle: localStorage.getItem('iconStyle') || 'emoji',
                autoLocation: localStorage.getItem('autoLocation') === 'true'
            };

            const WEATHER_CODES = {
                0: { emoji: "‚òÄÔ∏è", material: "wb_sunny", night_emoji: "üåô", night_material: "nightlight_round", text: "Tr·ªùi quang, m√¢y t·∫°nh", color: ["#4FC3F7", "#00BCD4"] },
                1: { emoji: "üå§Ô∏è", material: "partly_cloudy_day", night_emoji: "‚òÅÔ∏è", night_material: "partly_cloudy_night", text: "Tr·ªùi quang, ch·ªß y·∫øu n·∫Øng", color: ["#64B5F6", "#81C784"] },
                2: { emoji: "‚õÖÔ∏è", material: "cloudy", text: "Tr·ªùi quang, m√¢y r·∫£i r√°c", color: ["#A5D6A7", "#90A4AE"] },
                3: { emoji: "‚òÅÔ∏è", material: "cloudy", text: "Tr·ªùi nhi·ªÅu m√¢y", color: ["#B0BEC5", "#78909C"] },
                45: { emoji: "üå´Ô∏è", material: "foggy", text: "S∆∞∆°ng m√π", color: ["#ECEFF1", "#CFD8DC"] },
                48: { emoji: "üå´Ô∏è", material: "foggy", text: "S∆∞∆°ng m√π ƒë√≥ng bƒÉng", color: ["#B0BEC5", "#90A4AE"] },
                51: { emoji: "üåßÔ∏è", material: "rainy", text: "M∆∞a ph√πn nh·∫π", color: ["#90CAF9", "#42A5F5"] },
                53: { emoji: "üåßÔ∏è", material: "rainy", text: "M∆∞a ph√πn v·ª´a", color: ["#64B5F6", "#2196F3"] },
                55: { emoji: "üåßÔ∏è", material: "rainy", text: "M∆∞a ph√πn n·∫∑ng", color: ["#42A5F5", "#1E88E5"] },
                56: { emoji: "üå®Ô∏è", material: "snowing", text: "M∆∞a tuy·∫øt nh·∫π ƒë√≥ng bƒÉng", color: ["#E1F5FE", "#B3E5FC"] },
                57: { emoji: "üå®Ô∏è", material: "snowing", text: "M∆∞a tuy·∫øt v·ª´a ƒë√≥ng bƒÉng", color: ["#B3E5FC", "#81D4FA"] },
                61: { emoji: "üíß", material: "rainy", text: "M∆∞a nh·∫π", color: ["#90CAF9", "#42A5F5"] },
                63: { emoji: "üíß", material: "rainy", text: "M∆∞a v·ª´a", color: ["#64B5F6", "#2196F3"] },
                65: { emoji: "üíß", material: "rainy", text: "M∆∞a n·∫∑ng h·∫°t", color: ["#42A5F5", "#1E88E5"] },
                66: { emoji: "üå®Ô∏è", material: "snowing", text: "M∆∞a nh·∫π ƒë√≥ng bƒÉng", color: ["#E1F5FE", "#B3E5FC"] },
                67: { emoji: "üå®Ô∏è", material: "snowing", text: "M∆∞a v·ª´a ƒë√≥ng bƒÉng", color: ["#B3E5FC", "#81D4FA"] },
                71: { emoji: "‚ùÑÔ∏è", material: "ac_unit", text: "Tuy·∫øt r∆°i nh·∫π", color: ["#E1F5FE", "#B3E5FC"] },
                73: { emoji: "‚ùÑÔ∏è", material: "ac_unit", text: "Tuy·∫øt r∆°i v·ª´a", color: ["#B3E5FC", "#81D4FA"] },
                75: { emoji: "‚ùÑÔ∏è", material: "ac_unit", text: "Tuy·∫øt r∆°i n·∫∑ng", color: ["#81D4FA", "#4FC3F7"] },
                77: { emoji: "üå®Ô∏è", material: "snowing", text: "H·∫°t tuy·∫øt r∆°i", color: ["#B3E5FC", "#81D4FA"] },
                80: { emoji: "‚õàÔ∏è", material: "thunderstorm", text: "M∆∞a r√†o nh·∫π", color: ["#8D6E63", "#6D4C41"] },
                81: { emoji: "‚õàÔ∏è", material: "thunderstorm", text: "M∆∞a r√†o v·ª´a", color: ["#6D4C41", "#5D4037"] },
                82: { emoji: "‚õàÔ∏è", material: "thunderstorm", text: "M∆∞a r√†o d·ªØ d·ªôi", color: ["#5D4037", "#4E342E"] },
                85: { emoji: "üå®Ô∏è", material: "snowing", text: "M∆∞a tuy·∫øt nh·∫π", color: ["#E1F5FE", "#B3E5FC"] },
                86: { emoji: "üå®Ô∏è", material: "snowing", text: "M∆∞a tuy·∫øt v·ª´a", color: ["#B3E5FC", "#81D4FA"] },
                95: { emoji: "‚ö°Ô∏è", material: "thunderstorm", text: "D√¥ng b√£o", color: ["#6D4C41", "#5D4037"] },
                96: { emoji: "‚ö°Ô∏è", material: "thunderstorm", text: "D√¥ng b√£o c√≥ m∆∞a ƒë√° nh·∫π", color: ["#5D4037", "#4E342E"] },
                99: { emoji: "‚ö°Ô∏è", material: "thunderstorm", text: "D√¥ng b√£o c√≥ m∆∞a ƒë√° n·∫∑ng", color: ["#4E342E", "#3E2723"] },
            };
            
            // PIXEL_ICONS: Th√™m m√£ th·ªùi ti·∫øt v√† link icon Pixel c·ªßa bro v√†o ƒë√¢y
            const PIXEL_ICONS = {
                '0': 'clear_day.png', '0_night': 'clear_night.png',
                '1': 'partly_cloudy_day.png', '1_night': 'partly_cloudy_night.png',
                '2': 'mostly_cloudy_day.png', '2_night': 'mostly_cloudy_night.png',
                '3': 'cloudy.png', '3_night': 'cloudy.png',
                '45': 'haze_fog_dust_smoke.png', '45_night': 'haze_fog_dust_smoke.png',
                '48': 'haze_fog_dust_smoke.png', '48_night': 'haze_fog_dust_smoke.png',
                '51': 'drizzle.png', '51_night': 'drizzle.png',
                '53': 'drizzle.png', '53_night': 'drizzle.png',
                '55': 'drizzle.png', '55_night': 'drizzle.png',
                '56': 'mixed_rain_snow.png', '56_night': 'mixed_rain_snow.png',
                '57': 'mixed_rain_snow.png', '57_night': 'mixed_rain_snow.png',
                '61': 'showers_rain.png', '61_night': 'showers_rain.png',
                '63': 'showers_rain.png', '63_night': 'showers_rain.png',
                '65': 'heavy_rain.png', '65_night': 'heavy_rain.png',
                '66': 'sleet_hail.png', '66_night': 'sleet_hail.png',
                '67': 'sleet_hail.png', '67_night': 'sleet_hail.png',
                '71': 'showers_snow.png', '71_night': 'showers_snow.png',
                '73': 'showers_snow.png', '73_night': 'showers_snow.png',
                '75': 'heavy_snow.png', '75_night': 'heavy_snow.png',
                '77': 'flurries.png', '77_night': 'flurries.png',
                '80': 'scattered_showers_day.png', '80_night': 'scattered_showers_night.png',
                '81': 'scattered_showers_day.png', '81_night': 'scattered_showers_night.png',
                '82': 'scattered_showers_day.png', '82_night': 'scattered_showers_night.png',
                '85': 'scattered_snow_showers_day.png', '85_night': 'scattered_snow_showers_night.png',
                '86': 'showers_snow.png', '86_night': 'showers_snow.png',
                '95': 'isolated_scattered_thunderstorms_day.png', '95_night': 'isolated_scattered_thunderstorms_night.png',
                '96': 'mixed_rain_hail_sleet.png', '96_night': 'mixed_rain_hail_sleet.png',
                '99': 'mixed_rain_hail_sleet.png', '99_night': 'mixed_rain_hail_sleet.png',
            };

            // Link icon chi ti·∫øt. Bro thay b·∫±ng link ·∫£nh Pixel c·ªßa bro nh√©
            const DETAIL_ICONS = {
                humidity: { emoji: "üíß", material: "humidity_mid", pixel: "https://placehold.co/100x100?text=Humidity" },
                wind: { emoji: "üí®", material: "air", pixel: "windy_breezy.png" },
                wind_direction: { emoji: "‚û°Ô∏è", material: "explore", pixel: "https://placehold.co/100x100?text=Wind+Direction" },
                uv: { emoji: "‚òÄÔ∏è", material: "wb_sunny", pixel: "https://placehold.co/100x100?text=UV" }
            };
            
            document.querySelector(`input[name="temp-unit"][value="${settings.tempUnit}"]`).checked = true;
            document.querySelector(`input[name="wind-unit"][value="${settings.windUnit}"]`).checked = true;
            document.querySelector(`input[name="icon-style"][value="${settings.iconStyle}"]`).checked = true;
            autoLocationToggle.checked = settings.autoLocation;

            const displayMessage = (message, isError = false) => {
                weatherInfoDiv.innerHTML = `
                    <div class="text-center font-semibold text-lg ${isError ? 'text-red-400' : 'text-white'}">
                        ${message}
                    </div>
                `;
                weatherInfoDiv.classList.remove('hidden');
                document.getElementById('forecast-section')?.remove();
            };

            const setWeatherBackground = (weatherCode) => {
                const colors = WEATHER_CODES[weatherCode]?.color || ["#1A202C", "#2D3748"];
                weatherBg.style.background = `linear-gradient(135deg, ${colors[0]}, ${colors[1]})`;
            };

            const getDetailIcon = (key) => {
                const icon = DETAIL_ICONS[key];
                if (settings.iconStyle === 'material') {
                    return `<span class="material-symbols-outlined text-3xl">${icon.material}</span>`;
                } else if (settings.iconStyle === 'pixel') {
                    return `<img src="${icon.pixel}" alt="${key} icon" class="w-8 h-8"/>`;
                }
                return `<span class="text-3xl">${icon.emoji}</span>`;
            }

            // ƒê√¢y l√† ch·ªó bro c·∫ßn thay link n√†y
            const getPixelIconUrl = (weatherCode, isNight) => {
                const pixelIcons = PIXEL_ICONS;
                const iconKey = isNight ? `${weatherCode}_night` : `${weatherCode}`;
                return pixelIcons[iconKey] || 'https://placehold.co/100x100?text=Pixel+Icon';
            };

            const displayWeather = (currentData, dailyData, city, uvIndex, timezone) => {
                const tempInCelsius = currentData.temperature_2m;
                let displayTemp = tempInCelsius.toFixed(1);
                let tempUnitText = '¬∞C';
                
                if (settings.tempUnit === 'fahrenheit') {
                    displayTemp = ((tempInCelsius * 9/5) + 32).toFixed(1);
                    tempUnitText = '¬∞F';
                }

                let displayWindSpeed = currentData.wind_speed_10m;
                let windUnitText = 'km/h';
                if (settings.windUnit === 'ms') {
                    displayWindSpeed = (displayWindSpeed / 3.6).toFixed(1);
                    windUnitText = 'm/s';
                }

                const humidity = currentData.relative_humidity_2m;
                const weatherCode = currentData.weather_code;

                const localTime = new Date().toLocaleTimeString('en-US', { timeZone: timezone, hour12: false });
                const localHour = parseInt(localTime.split(':')[0], 10);
                const isNight = localHour >= 18 || localHour < 6;
                
                let iconHtml;
                const weatherCodeInfo = WEATHER_CODES[weatherCode];
                if (settings.iconStyle === 'material') {
                    const materialIcon = isNight && weatherCodeInfo?.night_material ? weatherCodeInfo.night_material : weatherCodeInfo?.material;
                    iconHtml = `<span class="material-symbols-outlined text-6xl">${materialIcon || "help"}</span>`;
                } else if (settings.iconStyle === 'pixel') {
                    const pixelIconUrl = getPixelIconUrl(weatherCode, isNight);
                    iconHtml = `<img src="${pixelIconUrl}" alt="weather icon" class="w-24 h-24"/>`;
                } else {
                    const emojiIcon = isNight && weatherCodeInfo?.night_emoji ? weatherCodeInfo.night_emoji : weatherCodeInfo?.emoji;
                    iconHtml = `<span class="text-6xl">${emojiIcon || "‚ùì"}</span>`;
                }

                setWeatherBackground(weatherCode);

                const weatherHtml = `
                    <h2 class="capitalize">${city}</h2>
                    <div class="temp flex justify-center items-center">
                        ${iconHtml}
                        <span>${displayTemp}${tempUnitText}</span>
                    </div>
                    <div class="weather-details">
                        <div class="flex items-center gap-2">
                            ${getDetailIcon('humidity')}
                            <span>ƒê·ªô ·∫©m: <br/>${humidity}%</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${getDetailIcon('wind')}
                            <span>Gi√≥: <br/>${displayWindSpeed} ${windUnitText}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${getDetailIcon('wind_direction')}
                            <span>H∆∞·ªõng gi√≥: <br/>${currentData.wind_direction_10m}¬∞</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${getDetailIcon('uv')}
                            <span>Ch·ªâ s·ªë UV: <br/>${uvIndex !== undefined ? uvIndex : 'N/A'}</span>
                        </div>
                    </div>
                `;
                weatherInfoDiv.innerHTML = weatherHtml;
                weatherInfoDiv.classList.remove('hidden');

                const forecastSection = document.getElementById('forecast-section') || document.createElement('div');
                forecastSection.id = 'forecast-section';
                forecastSection.className = 'forecast-section';
                forecastSection.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4 mt-8">D·ª± b√°o 7 ng√†y t·ªõi</h3>
                    <div id="forecast-container" class="forecast-container"></div>
                `;
                document.querySelector('.container').appendChild(forecastSection);

                const forecastContainer = document.getElementById('forecast-container');
                forecastContainer.innerHTML = '';
                
                dailyData.time.forEach((day, index) => {
                    const dailyCard = document.createElement('div');
                    dailyCard.className = 'forecast-card';
                    const date = new Date(day);
                    const dayName = date.toLocaleDateString('vi-VN', { weekday: 'short' });
                    
                    let tempMax = dailyData.temperature_2m_max[index].toFixed(1);
                    let tempMin = dailyData.temperature_2m_min[index].toFixed(1);
                    if (settings.tempUnit === 'fahrenheit') {
                        tempMax = ((dailyData.temperature_2m_max[index] * 9/5) + 32).toFixed(1);
                        tempMin = ((dailyData.temperature_2m_min[index] * 9/5) + 32).toFixed(1);
                    }
                    
                    const dailyWeatherCode = dailyData.weather_code[index];
                    let dailyIconHtml;
                    const dailyWeatherCodeInfo = WEATHER_CODES[dailyWeatherCode];
                    if (settings.iconStyle === 'material') {
                        dailyIconHtml = `<span class="material-symbols-outlined text-4xl">${dailyWeatherCodeInfo?.material || "help"}</span>`;
                    } else if (settings.iconStyle === 'pixel') {
                        const iconUrl = getPixelIconUrl(dailyWeatherCode, false); // Ban ng√†y
                        dailyIconHtml = `<img src="${iconUrl}" alt="daily weather icon" class="w-16 h-16"/>`;
                    } else {
                        dailyIconHtml = `<span class="text-4xl">${dailyWeatherCodeInfo?.emoji || "‚ùì"}</span>`;
                    }

                    dailyCard.innerHTML = `
                        <p class="font-bold">${dayName}</p>
                        <div class="icon-placeholder">
                            ${dailyIconHtml}
                        </div>
                        <p class="font-medium">${tempMax}${tempUnitText} / ${tempMin}${tempUnitText}</p>
                    `;
                    forecastContainer.appendChild(dailyCard);
                });
            };

            const debounce = (func, delay) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), delay);
                };
            };

            const handleCityInput = debounce(async (e) => {
                const query = e.target.value.trim();
                if (query.length < 3) {
                    suggestionsList.classList.add('hidden');
                    return;
                }

                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5`, {
                        headers: { 'User-Agent': 'WeatherApp/1.0 (https://your-website.com)' }
                    });
                    
                    if (!response.ok) {
                        suggestionsList.classList.add('hidden');
                        return;
                    }

                    const data = await response.json();
                    
                    if (data.length > 0) {
                        suggestionsList.innerHTML = '';
                        data.forEach(item => {
                            const li = document.createElement('li');
                            li.textContent = item.display_name;
                            li.addEventListener('click', () => {
                                cityInput.value = item.display_name;
                                suggestionsList.classList.add('hidden');
                                getWeather(item.lat, item.lon, item.display_name);
                            });
                            suggestionsList.appendChild(li);
                        });
                        suggestionsList.classList.remove('hidden');
                    } else {
                        suggestionsList.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("L·ªói khi t√¨m ki·∫øm g·ª£i √Ω:", error);
                    suggestionsList.classList.add('hidden');
                }
            }, 300);

            const getWeather = async (lat, lon, cityName) => {
                if (!lat || !lon) {
                    displayMessage("Kh√¥ng th·ªÉ l·∫•y t·ªça ƒë·ªô th√†nh ph·ªë.");
                    return;
                }
                displayMessage("ƒêang t·∫£i d·ªØ li·ªáu th·ªùi ti·∫øt...");

                try {
                    const [weatherResponse, uvResponse] = await Promise.all([
                        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=7`),
                        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=uv_index_max&timezone=auto`)
                    ]);
                    
                    if (!weatherResponse.ok) {
                        displayMessage("C√≥ l·ªói khi l·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt. Vui l√≤ng th·ª≠ l·∫°i sau.", true);
                        return;
                    }

                    const weatherData = await weatherResponse.json();
                    const uvData = uvResponse.ok ? await uvResponse.json() : null;
                    const uvIndex = uvData?.daily?.uv_index_max?.[0];

                    displayWeather(weatherData.current, weatherData.daily, cityName, uvIndex, weatherData.timezone);

                } catch (error) {
                    console.error("L·ªói:", error);
                    displayMessage("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i sau.", true);
                }
            };
            
            const getWeatherByCurrentLocation = () => {
                if ("geolocation" in navigator) {
                    displayMessage("ƒêang l·∫•y v·ªã tr√≠ hi·ªán t·∫°i...");
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            // T√¨m t√™n th√†nh ph·ªë t·ª´ t·ªça ƒë·ªô
                            try {
                                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`, {
                                    headers: { 'User-Agent': 'WeatherApp/1.0 (https://your-website.com)' }
                                });
                                const data = await response.json();
                                const cityName = data.display_name || "V·ªã tr√≠ hi·ªán t·∫°i";
                                getWeather(lat, lon, cityName);
                            } catch (error) {
                                console.error("L·ªói khi l·∫•y t√™n th√†nh ph·ªë:", error);
                                getWeather(lat, lon, "V·ªã tr√≠ hi·ªán t·∫°i");
                            }
                        },
                        (error) => {
                            console.error("L·ªói ƒë·ªãnh v·ªã:", error.message);
                            let errorMessage;
                            if (error.code === error.PERMISSION_DENIED) {
                                errorMessage = "B·∫°n ƒë√£ t·ª´ ch·ªëi c·∫•p quy·ªÅn ƒë·ªãnh v·ªã. Vui l√≤ng b·∫≠t trong c√†i ƒë·∫∑t tr√¨nh duy·ªát ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.";
                            } else if (error.code === error.POSITION_UNAVAILABLE) {
                                errorMessage = "Kh√¥ng th·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠ hi·ªán t·∫°i. Vui l√≤ng ƒë·∫£m b·∫£o d·ªãch v·ª• ƒë·ªãnh v·ªã ƒë√£ ƒë∆∞·ª£c b·∫≠t.";
                            } else if (error.code === error.TIMEOUT) {
                                errorMessage = "Y√™u c·∫ßu l·∫•y v·ªã tr√≠ ƒë√£ h·∫øt th·ªùi gian. Vui l√≤ng th·ª≠ l·∫°i.";
                            } else {
                                errorMessage = "ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh khi l·∫•y v·ªã tr√≠. Vui l√≤ng th·ª≠ l·∫°i.";
                            }
                            displayMessage(errorMessage, true);
                        }
                    );
                } else {
                    displayMessage("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ t√≠nh nƒÉng ƒë·ªãnh v·ªã.", true);
                }
            };

            // Ki·ªÉm tra v√† t·ª± ƒë·ªông hi·ªán th·ªùi ti·∫øt n·∫øu c√†i ƒë·∫∑t ƒë∆∞·ª£c b·∫≠t
            if (settings.autoLocation) {
                getWeatherByCurrentLocation();
            }

            searchBtn.addEventListener('click', async () => {
                const query = cityInput.value.trim();
                if (!query) {
                    displayMessage("H√£y nh·∫≠p t√™n th√†nh ph·ªë.");
                    return;
                }
                displayMessage("ƒêang t√¨m ki·∫øm...");
                
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`, {
                        headers: { 'User-Agent': 'WeatherApp/1.0 (https://your-website.com)' }
                    });

                    if (!response.ok) {
                        displayMessage(`Kh√¥ng t√¨m th·∫•y th√†nh ph·ªë '${query}'. Vui l√≤ng th·ª≠ l·∫°i.`, true);
                        return;
                    }

                    const geoData = await response.json();
                    if (geoData.length === 0) {
                        displayMessage(`Kh√¥ng t√¨m th·∫•y th√†nh ph·ªë '${query}'. Vui l√≤ng th·ª≠ l·∫°i.`, true);
                        return;
                    }

                    const lat = geoData[0].lat;
                    const lon = geoData[0].lon;
                    const cityName = geoData[0].display_name;
                    getWeather(lat, lon, cityName);
                } catch (error) {
                    console.error("L·ªói:", error);
                    displayMessage("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i sau.", true);
                }
            });

            cityInput.addEventListener('input', handleCityInput);
            cityInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    searchBtn.click();
                }
            });
            cityInput.addEventListener('focus', () => {
                if (cityInput.value.length >= 3) {
                    suggestionsList.classList.remove('hidden');
                }
            });
            cityInput.addEventListener('blur', () => {
                setTimeout(() => { suggestionsList.classList.add('hidden'); }, 200);
            });

            currentLocationBtn.addEventListener('click', getWeatherByCurrentLocation);

            const updateSettingsUI = () => {
                document.querySelector(`input[name="temp-unit"][value="${settings.tempUnit}"]`).checked = true;
                document.querySelector(`input[name="wind-unit"][value="${settings.windUnit}"]`).checked = true;
                document.querySelector(`input[name="icon-style"][value="${settings.iconStyle}"]`).checked = true;
                autoLocationToggle.checked = settings.autoLocation;
            };
            updateSettingsUI();

            document.querySelectorAll('input[name="temp-unit"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    settings.tempUnit = e.target.value;
                    localStorage.setItem('tempUnit', settings.tempUnit);
                    const city = cityInput.value;
                    if (city) {
                        searchBtn.click();
                    }
                });
            });
            document.querySelectorAll('input[name="wind-unit"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    settings.windUnit = e.target.value;
                    localStorage.setItem('windUnit', settings.windUnit);
                    const city = cityInput.value;
                    if (city) {
                        searchBtn.click();
                    }
                });
            });
            document.querySelectorAll('input[name="icon-style"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    settings.iconStyle = e.target.value;
                    localStorage.setItem('iconStyle', settings.iconStyle);
                    const city = cityInput.value;
                    if (city) {
                        searchBtn.click();
                    }
                });
            });
            
            autoLocationToggle.addEventListener('change', (e) => {
                settings.autoLocation = e.target.checked;
                localStorage.setItem('autoLocation', settings.autoLocation);
            });

            settingsBtn.addEventListener('click', () => {
                settingsPanel.classList.toggle('hidden');
            });
        });
    </script>
</body>
</html>
